{% extends "base.html" %}

{%block title %}
<title>OP-Z Sample Manager</title>
{%endblock%}

{% block main %}
<h1>Welcome to OP-Z Sample Manager</h1>

<button onclick="fetchOpzSamples()" id="list-files">List Files</button>
<div id="sample-output"></div>

<div id="file-list">
    <h3>Kicks</h3>
    <div class="samplepackbox" id="1-kick"></div>
    <h3>Snares</h3>
    <div class="samplepackbox" id="2-snare"></div>
    <h3>Percussion</h3>
    <div class="samplepackbox" id="3-perc"></div>
    <h3>FX</h3>
    <div class="samplepackbox" id="4-fx"></div>
    <h3>Bass</h3>
    <div class="samplepackbox" id="5-bass"></div>
    <h3>Lead</h3>
    <div class="samplepackbox" id="6-lead"></div>
    <h3>Arpeggio</h3>
    <div class="samplepackbox" id="7-arpeggio"></div>
    <h3>Chords</h3>
    <div class="samplepackbox" id="8-chord"></div>
</div>

<script>
    async function fetchOpzSamples() {
        try {
            const response = await fetch("http://localhost:5000/read-samples");
            if (!response.ok) {
                throw new Error("Network response was not ok: " + response.statusText);
            }
            const data = await response.json();

            // Clear existing slots
            data.categories.forEach((category, catIndex) => {
                const container = document.getElementById(category);
                container.innerHTML = ""; // clear previous content

                data.sampleData[catIndex].forEach((slot, slotIndex) => {
                    const slotDiv = document.createElement("div");
                    slotDiv.classList.add("sampleslot");
                    slotDiv.setAttribute("draggable", "true");
                    slotDiv.dataset.category = category;
                    slotDiv.dataset.slot = slotIndex;

                    const pathText = slot.path ? slot.path : "(empty)";
                    const text = document.createElement("span");
                    text.textContent = `Slot ${slotIndex + 1}: ${pathText}`;

                    const deleteBtn = document.createElement("button");
                    deleteBtn.textContent = "âœ•";
                    deleteBtn.classList.add("delete-btn");
                    deleteBtn.onclick = async () => {
                        const samplePath = slot.path;
                        if (!samplePath) return; // nothing to delete

                        const confirmed = confirm(`Delete sample?\n${samplePath}`);
                        if (!confirmed) return;

                        try {
                            const res = await fetch("http://localhost:5000/delete-sample", {
                                method: "DELETE",
                                headers: {
                                    "Content-Type": "application/json"
                                },
                                body: JSON.stringify({ path: samplePath })
                            });

                            if (!res.ok) throw new Error("Delete failed");

                            // Update UI to show it's empty now
                            slot.path = null;
                            text.textContent = `Slot ${slotIndex + 1}: (empty)`;
                        } catch (err) {
                            console.error("Failed to delete sample:", err);
                            alert("Could not delete sample.");
                        }
                    };

                    slotDiv.appendChild(text);
                    slotDiv.appendChild(deleteBtn);
                    container.appendChild(slotDiv);
                });
            });

        } catch (error) {
            console.error("Failed to fetch OP-Z samples:", error);
        }
    }

</script>


{% endblock %}

</html>